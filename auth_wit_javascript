<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script type="text/javascript">
        function GetCaObjectId() {
            let url = document.getElementById('url').value;
            let searchUrl = url + "/Services/PLL/CaseObject/Search";
            let caseNumber = document.getElementById('casenumber').value;
            let searchData = JSON.stringify({ CaseNumber: caseNumber });
            let token = document.getElementById('token').innerHTML;
            $.ajax({
                type: "POST",
                url: searchUrl,
                headers: {
                    'Authorization': `cityworks ${token}`
                },
                data: { data: searchData },
                success: function (result) {
                    document.getElementById('caobjectid').innerHTML = result.Value[0];
                },
                error: function (xhr, status, p3, p4) {
                    var err = "Error " + " " + status + " " + p3 + " " + p4;
                    if (xhr.responseText && xhr.responseText[0] == "{")
                        err = JSON.parse(xhr.responseText).Message;
                    console.log(err);
                }
            })
        }

        function Upload() {
            if (document.getElementById("upload").value != "") {
                var file = document.getElementById("upload").files[0];
                if (window.FormData !== undefined) {
                    var formData = new FormData();
                    var caseRelDocsData = {};
                    caseRelDocsData.CaObjectId = parseInt(document.getElementById('caobjectid').innerHTML);
                    let url = document.getElementById('url').value;
                    let relDocsUrl = url + "/Services/PLL/CaseRelDocs/Add";
                    formData.append("file", file);
                    formData.append("data", JSON.stringify(caseRelDocsData));
                    let token = document.getElementById('token').innerHTML;

                    $.ajax({
                        type: "POST",
                        url: relDocsUrl,
                        headers: {
                            'Authorization': `cityworks ${token}`
                        },
                        processData: false,
                        data: formData,
                        contentType: false,
                        success: function (result) {
                            document.getElementById('uploadresult').innerHTML = JSON.stringify(result);
                        },
                        error: function (xhr, status, p3, p4) {
                            var err = "Error " + " " + status + " " + p3 + " " + p4;
                            if (xhr.responseText && xhr.responseText[0] == "{")
                                err = JSON.parse(xhr.responseText).Message;
                            console.log(err);
                        }
                    });
                }
            }
        }

        function GetToken() {
            let url = document.getElementById('url').value;
            let username = document.getElementById('username').value;
            let password = document.getElementById('password').value;
            let postData = JSON.stringify({ LoginName: username, Password: password });
            let authUrl = url + "/Services/General/Authentication/Authenticate";
            $.ajax({
                type: "POST",
                url: authUrl,
                data: { data: postData },
                success: function (result) {
                    document.getElementById('token').innerHTML = result.Value.Token;
                },
                error: function (xhr, status, p3, p4) {
                    var err = "Error " + " " + status + " " + p3 + " " + p4;
                    if (xhr.responseText && xhr.responseText[0] == "{")
                        err = JSON.parse(xhr.responseText).Message;
                    console.log(err);
                }
            })
        }
    </script>
</head>

<body>
    <form>
        <h1>URL</h1>
        <input id="url" type="text" />
        <h1>Username</h1>
        <input id="username" type="text" />
        <h1>Password</h1>
        <input id="password" type="text" />
        <button type="button" onclick="GetToken()">Get Token</button>
        <h1 id="token"></h1>
        <h1>Case Number</h1>
        <input id="casenumber" type="text" />
        <button type="button" onclick="GetCaObjectId()">Find CaObjectId</button>
        <h1 id="caobjectid"></h1>
        <input id="upload" type="file" />
        <button type="button" onclick="Upload()">Upload</button>
        <h1 id="uploadresult"></h1>
    </form>
</body>

</html>
